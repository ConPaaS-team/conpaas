
cat <<EOF > $ROOT_DIR/$DEST/conpaas_install
#!/bin/bash

$DEST/devstack/stack.sh
sleep 1.5

echo "Authenticating..."
source $DEST/devstack/openrc admin admin
sleep 1.5

echo "Registering image"
glance image-create --name=conpaas --is-public=true --container-format=bare --disk-format=raw < /nutshell/$CONT_IMG

echo 'y' | rm /nutshell/$CONT_IMG

echo "create key pair"
nova keypair-add test > /nutshell/test.pem
chmod 600 /nutshell/test.pem

(cd /; patch -p1 < /nutshell/nbd.patch)
sed -i '/default_floating_pool/a auto_assign_floating_ip=True' /etc/nova/nova.conf
sed -i '/allow_resize_to_same_host/a ram_allocation_ratio=10' /etc/nova/nova.conf

sudo easy_install /nutshell/cpslib-*.tar.gz

(cd /nutshell ; tar -zxvf cpsdirector-*.tar.gz)
rm /nutshell/cpsdirector-*.tar.gz
(cd /nutshell/cpsdirector-*/ ; echo '172.16.0.1' | sudo make install)

sudo easy_install /nutshell/cpsclient-*.tar.gz

sudo cpsadduser.py test@email test password

source devstack/eucarc
/nutshell/scripts/configconpaas.sh /nutshell/director.cfg 172.16.0.1


EOF

chmod a+x $ROOT_DIR/$DEST/conpaas_install


