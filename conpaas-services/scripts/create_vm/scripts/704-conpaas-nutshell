
cat <<EOF > $ROOT_DIR/$DEST/conpaas_install
#!/bin/bash

$DEST/devstack/stack.sh
sleep 1.5

echo "Authenticating..."
source $DEST/devstack/openrc admin admin
sleep 1.5

echo "Registering image"
glance image-create --name=conpaas --is-public=true --container-format=bare --disk-format=raw < /nutshell/$CONT_IMG

echo 'y' | rm /nutshell/$CONT_IMG

echo "create key pair"
nova keypair-add test > /nutshell/test.pem
chmod 600 /nutshell/test.pem

(cd /; patch -p1 < /nutshell/nbd.patch)
sed -i '/default_floating_pool/a auto_assign_floating_ip=True' /etc/nova/nova.conf
sed -i '/allow_resize_to_same_host/a ram_allocation_ratio=10' /etc/nova/nova.conf

sudo easy_install /nutshell/cpslib-*.tar.gz

(cd /nutshell ; tar -zxvf cpsdirector-*.tar.gz)
rm /nutshell/cpsdirector-*.tar.gz
(cd /nutshell/cpsdirector-*/ ; echo '172.16.0.1' | sudo ./install.sh)

sudo easy_install /nutshell/cpsclient-*.tar.gz

IP=172.16.0.1
USR=test
PWD=password


sudo cpsadduser.py test@email $USR $PWD


(cd /nutshell ; tar -zxvf cps-tools-*.tar.gz)
(cd /nutshell/cps-tools-* ; sudo make install)

mkdir -p $HOME/.conpaas
cp /etc/cps-tools.conf $HOME/.conpaas/
sed -i "s/^\(# director_url\s*=\s*\).*$/director_url = https:\/\/$IP:5555/" cps-tools.conf
sed -i "s/^\(# username\s*=\s*\).*$/username = $USR/" cps-tools.conf

#maybe cps-user can be modified to accept pwd as parameter
#cps-user get_certificate $PWD


source devstack/eucarc
/nutshell/scripts/configconpaas.sh /nutshell/director.cfg $IP


EOF

chmod a+x $ROOT_DIR/$DEST/conpaas_install


