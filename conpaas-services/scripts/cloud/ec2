#!/bin/bash

# This is part of the contextualization script 
# for the Manager VM for Amazon EC2.
# The rest is generated by the frontend.

#. /var/lib/ec2-bootstrap/params

ec2_get_metadata() {
        [[ -z "$1" ]] && return 1
        VALUE=$(curl http://169.254.169.254/latest/meta-data/$1)
        echo "$VALUE"
}

# Set cloud-provided DNS servers in /etc/dhcp/dhclient.conf
for dns_server in `awk '/nameserver/ { print $2 }' /etc/resolv.conf` 
do 
    echo "prepend domain-name-servers $dns_server;" >> /etc/dhcp/dhclient.conf
done

IP_PUBLIC=$(ec2_get_metadata public-ipv4)
PRIVATE_IP=$(ec2_get_metadata local-ipv4)
PUBLIC_HOSTNAME=$(ec2_get_metadata public-hostname)
PRIVATE_HOSTNAME=$(ec2_get_metadata hostname)
VM_ID=$(ec2_get_metadata instance-id)

# Temp fix
echo "$PRIVATE_HOSTNAME" >/etc/hostname
echo -e "127.0.0.1\tlocalhost" > /etc/hosts.new
echo -e "$PRIVATE_IP\t$PRIVATE_HOSTNAME" >> /etc/hosts.new
echo -e "$IP_PUBLIC\t$PUBLIC_HOSTNAME" >> /etc/hosts.new
mv /etc/hosts.new /etc/hosts
chmod a+r /etc/hosts
hostname "$PRIVATE_HOSTNAME"


