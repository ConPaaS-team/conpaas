#!/bin/bash

##
# This script should be run inside a VM to install all dependencies needed by
# the ConPaaSWeb project. The resulting system installation is capable of
# hosting any of the ConPaaSWeb components such as web servers, proxies and
# PHP processes.
# 
# NOTE: This is an interactive script! The user must accept licenses and attend
#       to other prompts.
##


PREFIX=/

function install_deb() {
  sed --in-place 's/main/main contrib non-free/' /etc/apt/sources.list
  apt-get -f -y update
  # install packages
  apt-get -f -y install openssh-server \
        python python-pycurl python-cheetah nginx tomcat6-user memcached \
        make gcc g++ sun-java6-jdk erlang ant libxslt1-dev yaws subversion
  update-rc.d -f memcached remove
  update-rc.d -f nginx remove
  /etc/init.d/memcached stop
  /etc/init.d/nginx stop
  update-rc.d -f yaws remove
  /etc/init.d/yaws stop
  
  # add dotdeb repo for fpm
  echo "deb http://packages.dotdeb.org stable all" >> /etc/apt/sources.list
  wget -O - http://www.dotdeb.org/dotdeb.gpg 2>/dev/null | apt-key add -
  apt-get -f -y update
  apt-get -f -y install php5-fpm php5-curl php5-mcrypt php5-mysql php5-odbc php5-pgsql php5-sqlite php5-sybase php5-xmlrpc php5-xsl php5-adodb php5-memcache
  update-rc.d -f php5-fpm remove
  /etc/init.d/php5-fpm stop
  # remove dotdeb repo
  sed --in-place 's%deb http://packages.dotdeb.org stable all%%' /etc/apt/sources.list
  apt-get -f -y update
  
  echo > /var/log/cpsagent.web.log
  mkdir /etc/cpsagent.web/
  mkdir /var/tmp/cpsagent.web/
  mkdir /var/run/cpsagent.web/
  mkdir /var/cache/cpsagent.web/
  
  echo > /var/log/cpsmanager.web.log
  mkdir /etc/cpsmanager.web/
  mkdir /var/tmp/cpsmanager.web/
  mkdir /var/run/cpsmanager.web/
  mkdir /var/cache/cpsmanager.web/
  
  svn checkout http://scalaris.googlecode.com/svn/trunk/ scalaris-read-only
  cd scalaris-read-only
  ./configure
  make install
  cd ..
  rm -rf scalaris-read-only
}

mkdir -p $PREFIX

install_deb
