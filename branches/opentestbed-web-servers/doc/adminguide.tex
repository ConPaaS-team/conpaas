\documentclass[12pt]{article}
\usepackage{listings}
\usepackage{framed}
\usepackage{hyperref}


\newenvironment{what}
{\begin{description} \item [What is happening now?] \hfill \\}
{\end{description}}

\newenvironment{framedbox}[1]%
{\begin{framed}
 \begingroup
 \fontsize{#1}{#1}\selectfont
}
{
 \endgroup
 \end{framed}
}

\pagestyle{myheadings}
\markright{Administrator Guide:ConPaaS Web Hosting Service}

\begin{document}
\title{Administrator Guide: ConPaaS Web Hosting Service}
\date{August 15, 2011}
\thispagestyle{empty}

\begin{center}
\begingroup
\fontsize{20pt}{20pt}\selectfont
\textbf{Administrator Manual: ConPaaS \linebreak \linebreak Web Hosting Service} \linebreak
\endgroup

\begingroup
\fontsize{16pt}{16pt}\selectfont
August 15, 2011
\endgroup
\end{center}

\section{Using Amazon Web Services}
The Web Hosting Service is capable of running over the Elastic Compute Cloud
(EC2) of Amazon Web Services (AWS). This section describes the process of
configuring an AWS account to run the Web Hosting Service.

\subsection{Create an EBS backed AMI on Amazon EC2}
The Web Hosting Service requires the creation of an Amazon Machine Image(AMI)
to contain the dependencies of it's processes.
The easiest method of creating a new Elastic Block Store backed Amazon Machine
Image is to start from an already existing one, customize it and save the
resulting filesystem as a new AMI. The following steps explains how to setup an
AMI using this methodology.

\begin{enumerate}
\item Search the public AMIs for a Debian squeeze EBS AMI and run an instance
      of it.
\item Download conpaas\_web\_deps script and run it inside the instance.
      This script will install all of the dependencies of the manager and
      agent processes as well as create the necessary directory structure.
\item Clean the filesystem by removing any temporary files you may have
      created.
\item Go to the EC2 administration page at the AWS website, right click on the
      running instance and click on "Create Image (EBS AMI)".
      AWS documentation \href{http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html?Tutorial_CreateImage.html}{here}.
\end{enumerate}

\subsection{Create a Security Group}
An AWS security group is an abstraction of a set of firewall rules to limit
inbound traffic. The default policy of a new group is to deny all inbound
traffic. Therefore, one needs to specify a whitelist of protocols and
destination ports that are accesible from the outside.
The Web Hosting Service uses TCP ports 80, 8080 and 9000. All three ports
should be open for all running instances.
AWS documentation \href{http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html?using-network-security.html}{here}.


\section{Setup ConPaaS Front-end}
The ConPaaS Front-end is a web application that allows users to manager their
ConPaaS services. Users can create, configure and terminate services through
it. The Front-end supports running ConPaaS over AWS only. This section
describes the process of setting up a ConPaaS Front-end.

\subsection{Create Mysql Database}
The ConPaaS Front-end uses a Mysql database to store data about users and their
services. The following script for Mysql creates a new user DB\_USER with
password DB\_PASSWD and a database DB\_NAME. It grants all access permissions
to user DB\_USER on the new database. Finally, it creates the database schema.

Note that the database tables use the \textbf{InnoDB} mysql engine. This is
required to maintain transactional consistency. If the tables do not use
InnoDB, user credit control will not function properly.

\begin{framedbox}{12pt}\begin{verbatim}
create user 'DB_USER'@'%' identified by 'DB_PASSWD';
create database DB_NAME;
grant all on DB_NAME.* to 'DB_USER'@'%';

use DB_NAME;

CREATE TABLE `users` (
  `uid` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(256) DEFAULT NULL,
  `fname` varchar(256) DEFAULT NULL,
  `lname` varchar(256) DEFAULT NULL,
  `email` varchar(256) DEFAULT NULL,
  `affiliation` varchar(256) DEFAULT NULL,
  `passwd` varchar(256) DEFAULT NULL,
  `created` date DEFAULT NULL,
  `credit` int(11) DEFAULT 0,
  PRIMARY KEY (`uid`),
  KEY `searchname` (`username`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=latin1;

CREATE TABLE `services` (
  `sid` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(256) DEFAULT NULL,
  `type` varchar(32) DEFAULT NULL,
  `state` int(11) DEFAULT NULL,
  `creation_date` datetime DEFAULT NULL,
  `manager` varchar(512) DEFAULT NULL,
  `uid` int(11) DEFAULT NULL,
  `vmid` varchar(256) DEFAULT NULL,
  `cloud` varchar(32) DEFAULT NULL,
  PRIMARY KEY (`sid`),
  KEY `searchbystate` (`state`),
  KEY `searchbyuser` (`uid`)
)ENGINE=InnoDB AUTO_INCREMENT=59 DEFAULT CHARSET=latin1;
\end{verbatim}\end{framedbox}

\subsection{Configure the Front-end}
The ConPaaS Front-end code is a collection of PHP scripts. The following
instructions detail the configuration of the Front-end.

\begin{enumerate}
\item Place the PHP code at the document root of the target web server such
      that the file named \_\_init\_\_.php is directly underneath it.
\item Create a directory to hold the configuration of the Front-end. This
      directory should be located outside the document root of the web server
      as it will contain sensitive information.
\item Edit the CONF\_DIR variable in \_\_init\_\_.php such that it points to the
      configuration directory path.

\item EC2 instances can be passed a limited amount of data at boot time which
can be used to bootstrap them. When the Front-end creates a new manager node it
passes to it a configuration script that is executed at boot time.
Create a file at CONF\_DIR/manager-user-data with the following contents:
\begin{framedbox}{8pt}\begin{verbatim}
#!/bin/bash

export SOURCE=
export EC2_USER=
export EC2_PASSWORD=
export PUBLIC_IP=`/usr/bin/curl http://169.254.169.254/latest/meta-data/public-ipv4`

wget -P /root/ $SOURCE/ConPaaSWeb.tar.gz
wget -P /root/ $SOURCE/manager-start
wget -P /root/ $SOURCE/ec2-agent-user-data

cat <<EOF > /root/config.cfg
[iaas]
DRIVER = EC2

## EC2
EC2_USER = $EC2_USER
EC2_PASSWORD = $EC2_PASSWORD
EC2_IMAGE_ID = ami-5fc70136
EC2_SIZE_ID = t1.micro
EC2_SECURITY_GROUP_NAME = contrail
EC2_KEY_NAME = contrail
EC2_AGENT_USERDATA = /root/ec2-agent-user-data

[manager]
TYPE = %CONPAAS_SERVICE_TYPE%
BOOTSTRAP = $SOURCE
MEMCACHE_ADDR = 127.0.0.1:11211

ROOT = 
LOG_FILE = %(ROOT)s/var/log/cpsmanager.web.log
ETC = %(ROOT)s/etc/cpsmanager.web/
VAR_TMP = %(ROOT)s/var/tmp/cpsmanager.web/
VAR_CACHE = %(ROOT)s/var/cache/cpsmanager.web/
VAR_RUN = %(ROOT)s/var/run/cpsmanager.web/
CODE_REPO = %(VAR_CACHE)s/code_repo
FE_SERVICE_ID = %CONPAAS_SERVICE_ID%
FE_CREDIT_URL = PATH_TO/callback/decrementUserCredit.php
FE_TERMINATE_URL = PATH_TO/callback/terminateService.php
EOF

chmod 755 /root/manager-start
/root/manager-start
\end{verbatim}\end{framedbox}
Make sure to fill in EC2\_USER and EC2\_PASSWORD with the AWS access and secret
keys respectively. The SOURCE variable should be pointing to a URL where the
manager and agents can fetch the code and scripts required for them to start.
The specified URL should be a directory with the following contents:
\begin{itemize}
\item ConPaaSWeb.tar.gz: an archive containing the full source of the web
      hosting platform.
\item The the following bootstrapping scripts which can be found in the scripts
      directory in the web hosting service's code base:
  \begin{itemize}
    \item manager-start
    \item ec2-agent-user-data
    \item agent-start
    \item agent-stop
  \end{itemize}
\end{itemize}
The entries labeled FE\_CREDIT\_URL and FE\_TERMINATE\_URL should be complete
URLs pointing to the published front-end.


\item Create a new file at CONF\_DIR/db.ini with the following contents:
\begin{framedbox}{12pt}\begin{verbatim}
[mysql]
server = "SERVER_IP"
user = "DB_USER"
pass = "DB_PASSWD"
db = "DB_NAME"
\end{verbatim}\end{framedbox}
      Where SERVER\_IP is the IP address of the database server and DB\_* are the
      same parameters used when creating the Mysql database.
\item Create a new file at CONF\_DIR/aws.ini with the following contents:
\begin{framedbox}{12pt}\begin{verbatim}
ami = "AMI_ID"
security_group = "SECURITY_GROUP_NAME"
keypair = "KEYPAIR_NAME"
user_data_file = "FULL_PATH_TO/manager-user-data"
instance_type = "t1.micro"
\end{verbatim}\end{framedbox}
      Where AMI\_ID is the identifier of the created Amazon Machine Image,
      SECURITY\_GROUP\_NAME is the name of the created security group and
      KEYPAIR\_NAME is the name of the keypair to be used.
\item Create a new file at CONF\_DIR/log.ini with the following contents:
\begin{framedbox}{12pt}\begin{verbatim}
[log]
file = "FULL_PATH_TO_LOG_FILE"
\end{verbatim}\end{framedbox}
Where FULL\_PATH\_TO\_LOG\_FILE is the full path to the file where errors will be reported.
\item edit lib/aws-sdk/config.inc.php, fill in AWS\_KEY/AWS\_SECRET\_KEY with access key and secret key
\end{enumerate}

\end{document}
