\documentclass[10pt]{article}

%\usepackage{listings}
%\usepackage{framed}
\usepackage{hyperref}
\usepackage{url}
\usepackage{ulem} \normalem

\usepackage{fancyvrb}
\DefineVerbatimEnvironment%
  {code}%
  {Verbatim}%
  {frame=single,framesep=1mm,fontsize=\rm,resetmargins=true}

% \newenvironment{what}
% {\begin{description} \item [What is happening now?] \hfill \\}
% {\end{description}}

% \newenvironment{framedbox}[1]%
% {\begin{framed}
%  \begingroup
%  \fontsize{#1}{#1}\selectfont
% }
% {
%  \endgroup
%  \end{framed}
% }


\begin{document}
\title{ConPaaS -- Administrator guide}
\author{Ismail El Helw \and Guillaume Pierre}
\maketitle

\vfil
\tableofcontents
\vfil
\newpage

\section{Installation Overview}

For installing and using the ConPaaS web hosting platform, you will need:

\begin{itemize} 
\item access to Amazon EC2 or to an OpenNebula cloud
\item a machine (not necessarily part of the cloud) to host the ConPaaS
web front-end
\end{itemize}

ConPaaS uses customized VM images for hosting web applications. The first
step of the installation is to create a ConPaaS customized image. Section
~\ref{sec:ec2image} describes the creation of VM images for Amazon EC2,
while section~\ref{sec:oneimage} describes the creation of VM images for
OpenNebula.

Alternatively, you can download one of the ConPaaS images that we created
for OpenNebula, from the ``Downloads'' section of our web site:

 \url{http://www.conpaas.eu}

The second (and last) step of the ConPaaS installation is to setup the 
ConPaaS web front-end. This is discussed in section~\ref{sec:frontend}. 

\section{Creating a ConPaaS image for Amazon EC2}
\label{sec:ec2image}

The Web Hosting Service is capable of running over the Elastic Compute
Cloud (EC2) of Amazon Web Services (AWS). This section describes the
process of configuring an AWS account to run the Web Hosting Service.
You can skip this section if you plan to install ConPaaS over
OpenNebula.

If you are new to EC2, you will need to create an account at
\url{http://aws.amazon.com/ec2/}. A very good EC2 documentation can be
found at
\url{http://docs.amazonwebservices.com/AWSEC2/latest/GettingStartedGuide/}.

\subsection{Create an EBS backed AMI on Amazon EC2}

The Web Hosting Service requires the creation of an Amazon Machine
Image (AMI) to contain the dependencies of it's processes.  The
easiest method of creating a new Elastic Block Store backed Amazon
Machine Image is to start from an already existing one, customize it
and save the resulting filesystem as a new AMI. The following steps
explains how to setup an AMI using this methodology.

\begin{enumerate}
\item Search the public AMIs for a Debian squeeze EBS AMI and run an
  instance of it. If you are going to use micro-instances then the AMI
  with ID \verb+ami-e0e11289+ could be a good choice.

\item Upload the \verb+web-servers/conpaas_web_deps+ script to the instance:
  \begin{code}
    chmod 0400 yourpublickey.pem
    scp -i yourpublickey.pem web-servers/conpaas_web_deps \
      root@instancename.com:
  \end{code}

\item Now, ssh to your instance:
  \begin{code}
    ssh -i yourpublickey.pem root@your.instancename.com
  \end{code}
  Run the \verb+conpaas_web_deps+ script inside the instance. This
  script will install all of the dependencies of the manager and agent
  processes as well as create the necessary directory structure. At
  some point the script requests to accept licenses, accept them.

\item Clean the filesystem by removing the
  \verb+conpaas_web_deps+ file and any other temporary files you might
  have created.

\item Go to the EC2 administration page at the AWS website, right
  click on the running instance and select ``\emph{Create Image (EBS
    AMI)}''.  AWS
  documentation is available at
  \url{http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html?Tutorial_CreateImage.html}.

\item After the image has been fully created, you can return to the
  EC2 dashboard, right-click on your instance, and terminate it.
\end{enumerate}

\subsection{Create a Security Group}

An AWS security group is an abstraction of a set of firewall rules to
limit inbound traffic. The default policy of a new group is to deny
all inbound traffic. Therefore, one needs to specify a whitelist of
protocols and destination ports that are accesible from the outside.
The Web Hosting Service uses TCP ports 80, 5555, 8080 and 9000. All
these ports should be open for all running instances.  AWS
documentation is available at
\url{http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html?using-network-security.html}.

\section{Creating a ConPaaS image for OpenNebula}
\label{sec:oneimage}

The Web Hosting Service is capable of running over an OpenNebula
installation. This section describes the process of configuring
OpenNebula to run ConPaaS. You can skip this section if you plan to
deploy ConPaaS over Amazon Web Services.

To create an image for OpenNebula you can execute the script\\
\verb+web-servers/scripts/opennebula-create-new-vm-image+ in any
64-bit Debian or Ubuntu machine.

\begin{enumerate}
\item Make sure your system has the following executables installed
  (they are usually located in \verb+/sbin+ or \verb+/usr/sbin+, so
  make sure these directories are in your \verb+$PATH+): % $
  \emph{dd parted losetup kpartx mkfs.ext3 tune2fs mount debootstrap
    chroot umount grub-install}
\item It is particularly important that you use Grub version 2. To
  install it:
  \begin{code}
  sudo apt-get install grub2
  \end{code}
\item Edit the
  \verb+web-servers/scripts/opennebula-create-new-vm-image+ script
  if necessary: there are two sections in the script that you might need
  to customize with parameters that are specific to your system. These
  sections are marked by comment lines containing the text "TO CUSTOMIZE:".
  There are comments explaining each customizable parameter. 
\item Execute the image generation script as root.
\item The script generates an image file called \verb+conpaas.img+
  by default. You can now register it in OpenNebula:
\begin{code}
  cat <<EOF > /tmp/conpaas.image
  NAME          = "Conpaas"
  PATH          = ${PWD}/conpaas.img
  PUBLIC        = YES
  DESCRIPTION   = "Conpaas vm image"
  EOF

  oneimage register /tmp/conpaas.image
\end{code}
\end{enumerate}


\paragraph{If things go wrong}~\\

Note that if anything fails during the image file creation, the script
will stop. However, it will not always reset your system to its
original state. To undo everything the script has done, follow these
instructions:

\begin{enumerate}
\item The image has been mounted as a separate file system. Find the
  mounted directory using command \verb+df -h+. The directory should
  be in the form of \verb+/tmp/tmp.X+.
  
\item There may be a \verb+dev+ and a \verb+proc+ directories mounted
  inside it. Unmount everything using:
  \begin{code}
    sudo umount /tmp/tmp.X/dev /tmp/tmp.X/proc /tmp/tmp.X
  \end{code}
  
\item Find which loop device your using:
  \begin{code}
    sudo losetup -a
  \end{code}
  
\item Remove the device mapping:
  \begin{code}
    sudo kpartx -d /dev/loopX
  \end{code}
  
\item Remove the binding of the loop device:
  \begin{code}
    sudo losetup -d /dev/loopX
  \end{code}

\item Delete the image file 

\item Your system should be back to its original state.
\end{enumerate}

\subsection{Make sure OpenNebula is properly configured}

There are two main topics that you should pay attention to:

\begin{enumerate}
\item Make sure you started OpenNebula's OCCI deamon. ConPaaS relies
  on it to communicate with OpenNebula.

\item At the end of the OCCI profile file \verb+occi_templates/common.erb+ 
  from your OpenNebula installation, add the content of the file
  \verb+misc/common.erb+ from the ConPaaS distribution. This new version 
  features a number of improvements from the standard version:
  \begin{itemize}
  \item The match for \verb+OS TYPE:arch+ allows the caller to specify
    the architecture of the machine.
  \item The graphics line allows for using vnc to connect to the VM.
    This is very useful for debugging purposes and is not necessary
    once testing is complete.
  \end{itemize}
\end{enumerate}

\section{Setup ConPaaS's Frontend}
\label{sec:frontend}

The ConPaaS frontend is a web application that allows users to manager
their ConPaaS services. Users can create, configure and terminate
services through it. This section describes the process of setting up
a ConPaaS frontend.

To setup your frontend, you will need a PHP-enabled web server and a
MySQL database. The easiest way to install them on a Debian or Ubuntu
machine is:

\begin{code}
  sudo apt-get install libapache2-mod-php5 php5-curl \
     php5-mysql mysql-server mysql-client
\end{code}

\subsection{Create a MySQL Database}

The ConPaaS frontend uses a MySQL database to store data about users
and their services. The script located in
\verb+frontend/scripts/frontend-db.sql+ creates a new user
\verb+DB_USER+ with password \verb+DB_PASSWD+ and a database
\verb+DB_NAME+. It grants all access permissions to user
\verb+DB_USER+ on the new database. Finally, it creates the database
schema. You must update the first four lines to change \verb+DB_USER+,
\verb+DB_PASSWD+ and \verb+DB_NAME+ to reasonable values.

Install a MysQL database if you don't have one already. You can now
create the database schema using this command, replacing \verb+ADMIN+
and \verb+ADMINPASSWORD+ with the MySQL administrator's name and
password:

\begin{code}
  mysql -u ADMIN -p < frontend-db.sql
\end{code}


You will be prompted for the administrator's password, then the
database schema will be created automatically.

\subsection{Configure the Front-end}

The ConPaaS Front-end code is a collection of PHP scripts. It can run
on any PHP-enabled Web server. We recommend using Apache with the
\verb+mod_php+ module. The following instructions detail the
configuration of the frontend once you have a working PHP-enabled Web
server.

\begin{enumerate}
\item Copy all files from the \verb+frontend/conf+ directory to a
  location \uline{\emph{outside}} of the Web server's document root.
  This directory contains sensitive configuration parameters which
  must not be accesible by external users. A good location could be
  for example \verb+/etc/conpaas+. Note that files in this
  directory must be readable by the Web server (in Debian and Ubuntu
  distributions the Web server runs under username \verb+www-data+).

  Edit each of these files to setup the required configuration
  parameters. Each variable should be described in the config file
  itself. If you are installing ConPaaS on EC2 you do not need to edit
  file \verb+opennebula.ini+. If you are installing ConPaaS on
  OpenNebula you do not need to edit file \verb+aws.ini+.

\item Place the PHP code found in directory \verb+frontend/www+ at the
  document root of the frontend web server such that the file named
  \verb+__init__.php+ is directly underneath it.

\item Edit the \verb+CONF_DIR+ variable in \verb+__init__.php+ such
  that it points to the configuration directory path chosen in step 1.

\item (Only if you are installing ConPaaS on EC2, and you obtained it 
  from the svn repository) Download the AWS sdk for PHP from
  \url{http://aws.amazon.com/sdkforphp/}.  Extract the sdk directory
  and rename it to \verb+aws-sdk+. Place it under the lib directory of
  the web document root such that \verb+lib/aws-sdk/+ contains a
  file named \verb+config-sample.inc.php+ (among others).

\item Inside the web document's root, copy
  \verb+lib/aws-sdk/config-sample.inc.php+ to
  \verb+lib/aws-sdk/config.inc.php+ and fill in \verb+AWS_KEY+,
  \verb+AWS_SECRET_KEY+, \verb+AWS_ACCOUNT_ID+ and
  \verb+AWS_CANONICAL_ID+ as instructed in the file's documentation.

\item (Only if you are installing ConPaaS from the svn repository)
  Make sure that the Web server's document directory contains a
  subdirectory named \verb+code+ and containing the following files:
  \verb+agent-start+, \verb+agent-stop+, \verb+ConPaaSWeb.tar.gz+,
  \verb+ec2-agent-user-data+ and \verb+manager-start+. These files
  contain the entire implementation of the Web hosting service. They
  are downloaded by newly created VM instances upon startup.

  Files \verb+ec2-manager-user-data+ and \verb+opennebula-user-data+
  must be placed in the frontend's configuration directory, and edited
  with configuration information.
 
\end{enumerate}

At this point, your front-end should be working!

\section{Miscellaneous}
\subsection{The credit system}

The frontend is designed to maintain accounting of resources used by
each user. When a new user is created, (s)he receives a number of
credits as specified in the ``main.ini'' configuration file. Later on,
one credit is substracted each time a VM is executed for (a fraction
of) one hour. The administrator can change the number of credits by
directly editing the frontend's database. 

\subsection{Application sandboxing}

The default ConPaaS configuration creates strong sandboxing so that
applications cannot open sockets, access the file system, execute
commands, etc. This makes the platform relatively secure against
malicious applications. On the other hand, it strongly restricts the
actions that ConPaaS applications can do. To reduce these security
measures to a more usable level, you need to edit two files:

\begin{itemize}
\item To change restrictions applied to PHP applications, edit file
  \verb+web-servers/etc/fpm.tmpl+ to change the list of
  \verb+disable\_functions+. Do not forget to recreate a file
  \verb+ConPaaSWeb.tar.gz+ out of the entire \verb+web-servers+
  directory, and to copy it at the URL specified in file
  \verb+frontend/conf/manager-user-data+.
\item To change restrictions applied to Java applications, edit file
  ``web-servers/etc/tomcat-catalina.policy''. Do not forget to
  recreate a file ConPaaSWeb.tar.gz out of the entire ``web-servers''
  directory, and to copy it at the URL specified in file
  ``frontend/conf/manager-user-data''.
\end{itemize}


\subsection{Monitoring}
The ConPaaS virtual machines are monitored through Ganglia 
(\url{http://ganglia.sourceforge.net/}). The manager VM holds
the Ganglia monitoring database, and also a web front-end
where you can view the gathered performance information. The
web front-end is accessible at:

\url{http://<manager_ip_address>:8080} 

\end{document}
