\documentclass[10pt]{article}

\input{conpaasdoc}

\title{ConPaaS -- Installation guide\htmlonly{ [\xml{a href="installation.pdf"}pdf\xml{/a}]}}
\htmltitle{ConPaaS -- Installation guide}
\author{Ismail El Helw \and Adriana Szekeres \and Guillaume Pierre \and Emanuele Rocca}
\date{ConPaaS-1.0.0}

\begin{document}

\maketitle

\T\vfil
\T\tableofcontents
\T\vfil
\T\newpage

\section{Installation Overview}
\label{sec:overview}

\xlink{ConPaaS}{http://www.conpaas.eu} is composed of two parts: a
front end, and a collection of services. The front-end is a regular
Web site which allows ConPaaS users to access the system. It is
implemented in PHP with MySQL, and can run on any PHP-enabled Web
server (inside or outside the cloud).  Services are designed to run
either in an OpenNebula cloud installation, or in the Amazon Web
Services cloud.

Installing ConPaaS requires to take the following steps:

\begin{enumerate}
\item Choose a VM image customized for hosting the services, or create a new
one. Details on how to do this vary depending on the choice of cloud where
ConPaaS will run. Instructions on how to find or create a ConPaaS image
suitable to run on Amazon EC2 can be found in Section~\ref{sec:ec2image}. 
Section~\ref{sec:oneimage} describes how to create a ConPaaS image for OpenNebula.
\item Setup and configure the ConPaaS frontend. All system
  configuration takes place in the frontend. Frontend installation and
  configuration is discussed in Section~\ref{sec:frontend}.
\end{enumerate}

\section{Using ConPaaS on Amazon EC2}
\label{sec:ec2image}

The Web Hosting Service is capable of running over the Elastic Compute
Cloud (EC2) of Amazon Web Services (AWS). This section describes the
process of configuring an AWS account to run the Web Hosting Service.
You can skip this section if you plan to install ConPaaS over
OpenNebula.

If you are new to EC2, you will need to create an account at
\url{http://aws.amazon.com/ec2/}. A very good introduction to EC2 can be found
at \url{http://docs.amazonwebservices.com/AWSEC2/latest/GettingStartedGuide/}.

\subsection{Pre-built EBS Amazon Machine Image}

The Web Hosting Service requires the usage of an Amazon Machine Image (AMI) to
contain the dependencies of its processes. For your convenience we provide a
pre-built public AMI, already configured and ready to be used on Amazon EC2,
for each availability zone supported by ConPaaS. The AMI IDs of said images
are:

\begin{itemize}
    \item \verb+ami-c2941af2+ United States West (Oregon)
    \item \verb+ami-4b249322+ United States East (Northern Virginia)
    \item \verb+ami-99fcfaed+ Europe West (Ireland)
\end{itemize}

You can use one of these values when configuring your ConPaaS frontend
installation as described in Section~\ref{sec:frontend}.

\subsection{Create an EBS backed AMI on Amazon EC2}

Using pre-built Amazon Machine Images is the recommended way of running ConPaaS
on Amazon EC2, as described in the previous section. However, you can also
create a new Elastic Block Store backed Amazon Machine Image yourself, for example
in case you wish to run ConPaaS in a different Availability Zone.
The easiest way to do that is to start from an already existing AMI, customize
it and save the resulting filesystem as a new image. The following steps explains
how to setup an AMI using this methodology.

\begin{enumerate}
\item Log in the AWS management console, select the ``EC2'' tab, then ``AMIs''
in the left-side menu. Search the public AMIs for a Debian Squeeze EBS AMI and
start an instance of it. If you are going to use micro-instances then the AMI
with ID \verb+ami-e0e11289+ in the US East zone could be a good choice.

\item Upload the \textit{conpaas-services/scripts/create\_vm/ec2-setup-new-vm-image.sh} script to the instance:
  \begin{verbatim}
    chmod 0400 yourpublickey.pem
    scp -i yourpublickey.pem \
      conpaas-services/scripts/create_vm/ec2-setup-new-vm-image.sh \
      root@instancename.com:
  \end{verbatim}

\item Now, ssh to your instance:
  \begin{verbatim}
    ssh -i yourpublickey.pem root@your.instancename.com
  \end{verbatim}
  Run the \verb+ec2-setup-new-vm-image.sh+ script inside the instance.
  This script will install all of the dependencies of the manager and
  agent processes as well as create the necessary directory structure.

\item Clean the filesystem by removing the
  \verb+ec2-setup-new-vm-image.sh+ file and any other temporary files you might
  have created.

\item Go to the EC2 administration page at the AWS website, right
  click on the running instance and select ``\emph{Create Image (EBS
    AMI)}''.  This step will take several minutes. More information about this step
 can be found at
  \url{http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html?Tutorial\_CreateImage.html}.

\item After the image has been fully created, you can return to the
  EC2 dashboard, right-click on your instance, and terminate it.
\end{enumerate}

\subsection{Create a Security Group}
\label{sec:secgroup}

An AWS security group is an abstraction of a set of firewall rules to
limit inbound traffic. The default policy of a new group is to deny
all inbound traffic. Therefore, one needs to specify a whitelist of
protocols and destination ports that are accessible from the outside. 
The following ports should be open for all running instances: 
\begin{itemize}
\item TCP ports 80, 443, 5555, 8000, 8080 and 9000 -- used by the Web Hosting service
\item TCP port 3306 -- used by the MySQL service
\item TCP ports 8020, 8021, 8088, 50010, 50020, 50030, 50060, 50070, 50075, 50090, 50105, 54310 and 54311 -- used by the Map Reduce service
\item TCP ports 4369, 14194 and 14195 -- used by the Scalarix service
\item TCP ports 8475, 8999 -- used by the TaskFarm service
\end{itemize}

AWS documentation is available at
\url{http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/index.html?using-network-security.html}.

\section{Creating a ConPaaS image for OpenNebula}
\label{sec:oneimage}

The Web Hosting Service is capable of running over an OpenNebula
installation. This section describes the process of configuring
OpenNebula to run ConPaaS. You can skip this section if you plan to
deploy ConPaaS over Amazon Web Services.

To create an image for OpenNebula you can execute the script\\
\textit{conpaas-services/scripts/create\_vm/opennebula-create-new-vm-image.sh}
in any 64-bit Debian or Ubuntu machine. Please note that you will need to have
root privileges on such a system. In case you do not have root access to a
Debian or Ubuntu machine please consider installing a virtual machine using
your favorite virtualization technology, or running a Debian/Ubuntu instance in
the cloud.

\begin{enumerate}
\item Make sure your system has the following executables installed
  (they are usually located in \verb+/sbin+ or \verb+/usr/sbin+, so
  make sure these directories are in your \verb+$PATH+): % $
  \emph{dd parted losetup kpartx mkfs.ext3 tune2fs mount debootstrap
    chroot umount grub-install}
\item It is particularly important that you use Grub version 2. To
  install it:
  \begin{verbatim}
  sudo apt-get install grub2
  \end{verbatim}
\item Edit the
  \textit{conpaas-services/scripts/create\_vm/opennebula-create-new-vm-image.sh} script
  if necessary: there are two sections in the script that you might need
  to customize with parameters that are specific to your system. These
  sections are marked by comment lines containing the text "TO CUSTOMIZE:".
  There are comments explaining each customizable parameter. 
\item Obtain the id of the OpenNebula datastore you want to use by running
  \verb+onedatastore list+. In the following example, we will use "100" as our datastore id.
\item Execute the image generation script as root.
\item The script generates an image file called \verb+conpaas.img+ by default.
You can now register it in OpenNebula, replacing '100' in this example with the
datastore id obtained with \verb+onedatastore list+.

\vspace{10 mm}

\begin{verbatim}
  cat <<EOF > /tmp/conpaas-one.image
  NAME          = "Conpaas"
  PATH          = ${PWD}/conpaas.img
  PUBLIC        = YES
  DESCRIPTION   = "Conpaas vm image"
  EOF
  oneimage create /tmp/conpaas-one.image -d 100
\end{verbatim}
\end{enumerate}
% $>

\paragraph{If things go wrong}~\\

Note that if anything fails during the image file creation, the script will
stop and it will try to revert any change it has done. However, it might not
always reset your system to its original state. To undo everything the script
has done, follow these instructions:

\begin{enumerate}
\item The image has been mounted as a separate file system. Find the
  mounted directory using command \verb+df -h+. The directory should
  be in the form of \verb+/tmp/tmp.X+.
  
\item There may be a \verb+dev+ and a \verb+proc+ directories mounted
  inside it. Unmount everything using:
  \begin{verbatim}
    sudo umount /tmp/tmp.X/dev /tmp/tmp.X/proc /tmp/tmp.X
  \end{verbatim}
  
\item Find which loop device your using:
  \begin{verbatim}
    sudo losetup -a
  \end{verbatim}
  
\item Remove the device mapping:
  \begin{verbatim}
    sudo kpartx -d /dev/loopX
  \end{verbatim}
  
\item Remove the binding of the loop device:
  \begin{verbatim}
    sudo losetup -d /dev/loopX
  \end{verbatim}

\item Delete the image file 

\item Your system should be back to its original state.
\end{enumerate}

\subsection{Make sure OpenNebula is properly configured}

OpenNebula's OCCI daemon is used by ConPaaS to communicate with your
OpenNebula cluster.

\begin{enumerate}
\item Ensure your occi-server.conf contains the following lines in instance\_types:
\begin{verbatim}
:custom:
  :template: custom.erb
\end{verbatim}
\item At the end of the OCCI profile file \verb+occi_templates/common.erb+ 
  from your OpenNebula installation, add the content of the file
  \verb+misc/common.erb+ from the ConPaaS distribution. This new version 
  features a number of improvements from the standard version:
  \begin{itemize}
  \item The match for \verb+OS TYPE:arch+ allows the caller to specify
    the architecture of the machine.
  \item The graphics line allows for using vnc to connect to the VM.
    This is very useful for debugging purposes and is not necessary
    once testing is complete.

  \end{itemize}

\item Make sure you started OpenNebula's OCCI daemon

\end{enumerate}

\section{Setup ConPaaS's Frontend}
\label{sec:frontend}

The ConPaaS frontend is a web application that allows users to manage
their ConPaaS services. Users can create, configure and terminate
services through it. This section describes the process of setting up
a ConPaaS frontend.

\subsection{Server installation}
\label{sec:frontend-server}

The frontend can run on any Debian Squeeze machine. 

In case you want to run the frontend on Amazon EC2, make sure to perform the
following steps:

\begin{enumerate}
\item Log in the AWS management console, select the ``EC2'' tab, then ``AMIs''
in the left-side menu. Search the public AMI of Debian Squeeze and run an
instance of it.
\item In the ``Configure Firewall'' step of the Wizard, create a security group
  with port 443 (HTTPS) open. Also, if you haven't done so already, create a
  security group for the Web Hosting Service as explained in
  Section~\ref{sec:secgroup} and write its name down.
\end{enumerate}

If you decide to run the frontend on your own infrastructure, install Debian
Squeeze and make sure port 443 (HTTPS) is open.

Once the machine is running, log into it and follow the steps described in the
next section.

\subsection{Installation script}
\label{sec:frontend-installation-script}

An installation script is made available to ease the process of installing and
configuring a ConPaaS frontend. The script can be used if you are installing
the ConPaaS frontend starting from a Amazon Machine Image, but also in the case
you have just installed Debian Squeeze on your own hardware.

\begin{enumerate}
\item Download the version of ConPaaS you want to run from
\url{http://www.conpaas.eu}. For example: 

\verb+wget http://www.conpaas.eu/dl/ConPaaS-1.0.0.tar.gz+

\item Uncompress the downloaded tarball and edit the configuration options
available in \verb+frontend/scripts/install.sh+
\item Execute \verb+frontend/scripts/install.sh+ as root
\item Point your browser to the public IP address of your instance. You should
  see the ConPaaS frontend web page and you should be able to create a new user
  and start using ConPaaS
\end{enumerate}

\subsubsection{Updating a previous frontend installation}
The installation script can also be used in case you want to upgrade from a
previous ConPaaS installation. A backup of the ConPaaS frontend code, as well as
its configuration, will be created.

Just make sure to follow all the steps described in the previous section, in
particular do not forget to edit \verb+frontend/scripts/install.sh+ to reflect
your cloud setup.

\subsubsection{Important note on SSL certificates}
ConPaaS uses SSL certificates in order to secure the communication between you
and the frontend, but also to ensure that only authorized parties such as
yourself and the various component of ConPaaS can interact with the system.

It is therefore crucial that the SSL certificate of your frontend contains the
proper information. In particular, the commonName field of the certificate
should carry the public hostname of your frontend server. The installation
script takes care of setting up such a field. However, should your frontend
hostname change, please ensure you run the following commands:

\begin{verbatim}
sudo php frontend/scripts/generate-certs.php /etc/conpaas/certs
sudo service apache2 restart
\end{verbatim}

The next section describes in detail all the steps performed by the
installation script. You don't have to read it unless something went wrong with
the automatic installation procedure, or unless you want to know more about it.

\subsection{Manual setup}
\label{sec:frontend-manual}
To setup your frontend, you will need a PHP-enabled web server and a
MySQL database. The easiest way to install them on a Debian or Ubuntu
machine is:

\begin{verbatim}
  sudo apt-get install libapache2-mod-php5 php5-curl \
     php5-mysql mysql-server mysql-client
\end{verbatim}

ConPaaS uses PHP and Python OpenSSL wrappers to secure the HTTP communication.
Therefore, you must also install the openssl package. On Debian or Ubuntu,
openssl should have been installed with the installation of
package php5-curl, as it is one of its dependencies. Else, you could issue
the command:

\begin{verbatim}
  sudo apt-get install openssl
\end{verbatim}

\subsubsection{Create a MySQL Database}

The ConPaaS frontend uses a MySQL database to store data about users
and their services. The script located in
\verb+frontend/scripts/frontend-db.sql+ creates a new user
\verb+DB_USER+ with password \verb+DB_PASSWD+ and a database
\verb+DB_NAME+. It grants all access permissions to user
\verb+DB_USER+ on the new database. Finally, it creates the database
schema. You must update the first four lines to change \verb+DB_USER+,
\verb+DB_PASSWD+ and \verb+DB_NAME+ to reasonable values.

Install a MySQL database if you don't have one already. You can now
create the database schema using this command, replacing \verb+ADMIN+
with the MySQL administrator's name:

\begin{verbatim}
  mysql -u ADMIN -p < frontend-db.sql
\end{verbatim}

You will be prompted for the administrator's password, then the
database schema will be created automatically.

\subsubsection{Configure the Front-end}

The ConPaaS Front-end code is a collection of PHP scripts. It can run
on any PHP-enabled Web server. We recommend using Apache with the
\verb+mod_php+ module. The following instructions detail the
configuration of the frontend once you have a working PHP-enabled Web
server.

\begin{enumerate}
  \item Copy all files from the \verb+frontend/conf+ directory to a
  location \emph{outside} of the Web server's document root.
  This directory contains sensitive configuration parameters which
  must not be accessible by external users. A good location could be
  for example \verb+/etc/conpaas+. Note that files in this
  directory must be readable by the Web server (in Debian and Ubuntu
  distributions the Web server runs under username \verb+www-data+).

  Edit the following configuration files to setup the required
  configuration parameters:
  \begin{itemize}
  \item \texttt{main.ini}: general ConPaaS configuration
  \item \texttt{db.ini}: information about the frontend's database location
  \item \texttt{aws.ini}: information about your Amazon Web Services
    account (only necessary if you are installing ConPaaS on EC2)
  \item \texttt{opennebula.ini}: information about your OpenNebula
    deployment (only necessary if you are installing ConPaaS on
    OpenNebula)
  \item \texttt{welcome.txt}: the text of the email which will be sent
    to each new user
  \item \texttt{config/cloud/ec2.cfg}: information about your Amazon
    Web Services account (only necessary if you are installing ConPaaS
    on EC2)
  \item \texttt{config/cloud/opennebula.cfg}: information about your
    OpenNebula deployment (only necessary if you are installing
    ConPaaS on OpenNebula)
  \end{itemize}

  Each variable should be described in the config file itself. 

  \item Place the PHP code found in directory \verb+frontend/www+ at the
  document root of the frontend web server such that the file named
  \verb+__init__.php+ is directly underneath it.

  \item Edit the \verb+CONPAAS_CONF_DIR+ and \verb+CONPAAS_HOST+ variables in
  \verb+config-example.php+ such that they point to the configuration
  directory path chosen in step 1 and to the DNS name of the frontend
  (or its public IP address). Rename this file \verb+config.php+.

  \item (Only if you are installing ConPaaS on EC2, and you obtained it 
  from the svn repository) To run on EC2, the frontend uses the AWS
  sdk for PHP. Download the AWS sdk for PHP from
  \url{http://aws.amazon.com/sdkforphp/}.  Extract the sdk directory
  and rename it to \verb+aws-sdk+. Place it under the lib directory of
  the web document root such that \verb+lib/aws-sdk/+ contains a
  file named \verb+config-sample.inc.php+ (among others).

  \item (Only if you are installing ConPaaS on EC2) 
  Inside the web document's root, copy
  \verb+lib/aws-sdk/config-sample.inc.php+ to
  \verb+lib/aws-sdk/config.inc.php+ and fill in \verb+AWS_KEY+,
  \verb+AWS_SECRET_KEY+, \verb+AWS_ACCOUNT_ID+ and
  \verb+AWS_CANONICAL_ID+ as instructed in the file's documentation.

  \item (Only if you are installing ConPaaS from the svn repository)
  Make sure to copy folders \verb+config/manager+, \verb+config/cloud+,
  \verb+scripts/manager+ and \verb+scripts/cloud+ inside the 
  \verb+/etc/conpass+ folder. Then edit the 
  following file: config/cloud/opennebula.cfg or config/cloud/ec2.cfg,
  depending on the deployment cloud.

  Make sure that the Web server's document directory contains a
  subdirectory named \verb+download+, containing the archive
  \verb+ConPaaS.tar.gz+, which contains the entire implementation
  of the conpaas framework and services. This archive is downloaded by newly
  created VM instances upon startup. If you are installing ConPaaS from the svn
  repository, this archive can be obtained
  by running the mkarchive.sh, inside the \verb+conpaas-services+ folder.

\end{enumerate}

As ConPaaS uses SSL certificates, you must follow two more steps to setup the
secure communication. First, you must configure OpenSSL, and second, you must
configure Apache (or any other web server you are using) to work with SSL. The
idea is to make certificates optional (the user is not required to provide a
certificate when he/she uses the frontend, as the website is protected by login
checks), except for one folder, where access must be granted only based on
valid certificates. This folder contains a php script that generates new
certificates as requested by the manager in the name of its agents
- this folder basically contains the CA implementation.

In this guide we explain how to configure Apache to work with SSL for ConPaaS.
Of course a correct SSL configuration depends on the existing configuration of
you web server (e.g., if it host multiple websites, etc.) but we will explain
ConPaaS's needs on a default configuration (clean Apache installation) which
can further be applied to your existing configuration.

\begin{enumerate}[resume]
\item Configure OpenSSL.

  OpenSSL has a configuration file where you can set the default values of
  some of the fields that appear in the certificate. On Ubuntu or Debian
  this file can be found in \textit{/etc/ssl/openssl.cnf}. You should fill
  in the following fields from the section $[$\textit{req\_distingushed\_name}$]$:
  \textit{countryName\_default}, \textit{stateOrProvinceName\_default}.

  Also, you can make any other changes you consider. For example, you could
  change the number of bits used to generate a password from 1024 to 2048
  by filling in the \textit{default\_bits} field in the $[$\textit{req}$]$ section.

\item Configure the webserver to work with SSL.

  First, generate the CA certificate and the certificate of the frontend
  with the following command (assuming that the folder you chose at step
  1 to keep the sensitive configuration files is \verb+/etc/conpaas+ ):
  \begin{verbatim}
  sudo php frontend/scripts/generate-certs.php \
                                          /etc/conpaas/certs
  \end{verbatim}
  Second, configure the web server:
  \begin{itemize}
    \item To configure Apache with SSL support, you have to setup a new apache
      site that enables SSL support. Apache comes with a default ssl site that
      enables Apache to listen on port 443 for requests coming to the default
      Virtual Host. On Debian or Ubuntu this file can be found in
      \textit{/etc/apache2/sites-available/default-ssl}. You can start from this file
      and change it as you see fit for your site. For ConPaaS, it is enough just to
      edit a few lines in the existing default-ssl site in Apache:

      - inside $<$\textit{Directory /var/www/}$>$ change \textit{AllowOverride}
        to All (we provide a .htaccess file whose instructions must be taken
        into account).

      - change \textit{SSLCertificateFile} and \textit{SSLCertificateKeyFile} to point to
      \textit{/etc/conpaas/certs/cert.pem} and \textit{/etc/conpaas/certs/key.pem}, respectively.
      
      - uncomment the line containing the \textit{SSLCACertificateFile} variable and make it point
      to \textit{/etc/conpaas/certs/ca\_cert.pem}.

      Enable SSL and the SSL site with:
      \begin{verbatim}
        sudo a2enmod ssl
        sudo a2ensite default-ssl
        sudo /etc/init.d/apache2 reload
      \end{verbatim}

    %\item To configure Nginx with SSL support TODO:
  \end{itemize}
\end{enumerate}

At this point, your front-end should be working!

\section{Miscellaneous}
\label{sec:misc}

\subsection{The credit system}

The frontend is designed to maintain accounting of resources used by
each user. When a new user is created, (s)he receives a number of
credits as specified in the ``main.ini'' configuration file. Later on,
one credit is subtracted each time a VM is executed for (a fraction
of) one hour. The administrator can change the number of credits by
directly editing the frontend's database. 

\subsection{Application sandboxing}

The default ConPaaS configuration creates strong sandboxing so that
applications cannot open sockets, access the file system, execute
commands, etc. This makes the platform relatively secure against
malicious applications. On the other hand, it strongly restricts the
actions that ConPaaS applications can do. To reduce these security
measures to a more usable level, you need to edit two files:

\begin{itemize}
\item To change restrictions applied to PHP applications, edit file
  \verb+web-servers/etc/fpm.tmpl+ to change the list of
  \verb+disable\_functions+. Do not forget to recreate a file
  \verb+ConPaaSWeb.tar.gz+ out of the entire \verb+web-servers+
  directory, and to copy it at the URL specified in file
  \verb+frontend/conf/manager-user-data+.
\item To change restrictions applied to Java applications, edit file
  ``web-servers/etc/tomcat-catalina.policy''. Do not forget to
  recreate a file ConPaaSWeb.tar.gz out of the entire ``web-servers''
  directory, and to copy it at the URL specified in file
  ``frontend/conf/manager-user-data''.
\end{itemize}

\section{About this document}
\label{sec:about}


\begin{verbatim}
Copyright (c) 2010-2012, Contrail consortium.
All rights reserved.

Redistribution and use in source and binary forms, 
with or without modification, are permitted provided
that the following conditions are met:

 1. Redistributions of source code must retain the
    above copyright notice, this list of conditions
    and the following disclaimer.
 2. Redistributions in binary form must reproduce
    the above copyright notice, this list of 
    conditions and the following disclaimer in the
    documentation and/or other materials provided
    with the distribution.
 3. Neither the name of the Contrail consortium nor the
    names of its contributors may be used to endorse
    or promote products derived from this software 
    without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
\end{verbatim}


\end{document}


